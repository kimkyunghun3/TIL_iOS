## 컴퓨터 주기억장치의 4가지 영역

먼저 컴퓨터 주기억장치에는 4가지 영역이 존재한다.

Code - Data - Heap - Stack

순으로 되어 있으며 이는 낮은 주소에서부터 높은 주소의 방향이다.

하지만 실제로는 각 영역이 이렇게 낮은 주소, 높은 주소로 칼같이 나누어져 있지 않다. 이는 대부분이 그런 것이지 아닐 수도 있다. CPU, OS 마다 차이점이 존재한다!  이 내부구조까지 알기는 쉽지 않다 각각의 운영체제는 운영전략이 다르다는 것을 알고 있자!

그렇다면 메모리에서 우리가 앱을 여러개 실행할 때 그 곳의 4가지 영역에 어떤식으로 할당이 될까?

먼저 큰 메모리에서 첫 번째 앱을 실행 시 일부를 할당해준다. 그 이후에도 필요하다면 더 할당해주는 방식으로 되어있다. 그리고 만약 동시에 여러 앱이 실행되면 각각 일부씩 할당해주고 있다. 하지만 큰 메모리에서 크기를 넘겨버린다면? 그렇다면 이제 무엇인가 작업을 해야할 것이다.

일단 자주 안쓰는 것을 release 해주거나 disk로 swap 해줌으로써 불필요한 부분을 정리한다. 

그리고 만약 하나의 앱에서 많은 부분을 차지하고 있다면 경고를 날림으로써 이렇게 쓰면 안된다고 말해준다. 그러나 계속 많은 부분을 차지한다면!! 앱을 죽일 수 있다.

## ARC

ARC는 항상 runtime에 들어간다. 주기억장치를 시작할 때이기 떄문에 당연히 컴파일 타임이 아닌 런타임에 들어가는 것이 맞다. 하지만 규칙같은 경우에는 컴파일 타임에 정한다. 이런 것을 하겠다 이렇게 retain, release 할 것임을 미리 알려주고 이를 실행하는 것은 런타임에 한다.

ARC 자체는 실제로 자동적으로 모든 것을 해주는 것처럼 말하지만 여기에서 해주는 것은 retain, release만 해주고 있다. 이는 실제로 Objc 에서는 우리가 수동적으로 해줘야하는 부분이다.

대신 규칙들은 스스로 개발자가 해야한다! 그래서 우리는 이를 익히고 사용해야한다.

## ARC 사용하는 이유?

참조타입인 경우 메모리 관리를 위해서 필요하다. 특히 강한 순환 참조가 존재할 수 있는데 이 부분에서 메모리 누수가 발생할 수 있기 때문에 이를 해결하기 위해 ARC를 사용한다.

클로저에서도 내부에서 사용하는 것은 참조타입으로 된다. 이는 다른 곳에서 변할 수 있으므로 이를 해결하기 위해서 ARC를 사용할 수 있다. 캡쳐리스트를 통해 수동으로 제어할 수 있다.

### strong reference cycle

강한 참조 순환은 예를 들어 두 인스턴스가 서로 강하게 참조하고 있는 것을 의미한다. 이는 Person - Apartment 로 보았을 때 사람이 없더라도 아파트는 있을 수 있고 아파트가 없더라도 사람이 있을 수 있다. 그리고 서로는 내부에서 강하게 참조하고 있다. 이는 문제가 없어 보일 수 있지만, 실제로 한 곳에서 메모리 해제한 경우 문제가 생긴다.

ARC로 각각의 count가 2씩 되어있어서 한 곳에서 해제하더라도 1이 남아서 메모리 해제가 일어나지 않는다. 그래서 이는 메모리 누수로 이어질 수 있으며 낭비가 일어난다. 

이를 해결하기 위해서 아래의 두 가지 방법이 소개되고 있다.

### weak reference cycle

약한 참조 방식으로, 참조 시에 ARC가 늘어나지 않는다. 그러므로 Person - Apartment에서 각각이 참조하는 관계에서 Apartment에 weak를 선언함으로써 이곳의 ARC가 늘어나지 않는다. 그래서 만약 아파트를 없앤다면 이는 0이되므로 메모리 해제가 일어날 수 있으며 Person 에서는 2에서 1로 줄어들게 된다. 이렇게 강한 참조순환의 문제점을 해결할 수 있다. 

일반적으로 optional로 사용해서 값이 처음에 nil 일 수 있다고 말한다. 그리고 참조대상이 중간에 nil로도 다시 바꿀 수 있다. 값이 바뀔 수 있으므로 변수로 선언해야한다.

### unowned reference cycle

unowned 같은 경우에도 약한 참조방식과 비슷하다. 참조 시 ARC가 늘어나지 않는다. 하지만 다른점이 있다면 여기에서는 값이 항상 존재한다고 판단한다. 그 말은 즉, Optional이 아니라 항상 값이 있을 부분을 이곳에서 사용하고 있다. 그래서 optional를 사용하지 않는 것이 대부분이다.

하지만 Optional인 부분이 있다?

이 부분은 처음 선언된 곳에 nil로 되어 있는데 중간에 값이 생기는 것을 말한다. 그런 경우 옵셔널을 사용한다. 하지만 이 값이 생긴 이후에 값의 변화가 있으면 안된다.

### 이제 주로 나오는 면접 질문에 대한 답변을 해보도록 하자!

- ARC란 무엇인지 설명하시오.

ARC란, **Automatic Reference Counting으로 자동으로 참조 카운트를 해주는 것을 말한다. 이는 참조타입인 Class에서 주로 일어나는 참조 문제를 해결하기 위한 도구로 사용되며 실제로 ARC에서 자동적으로 하는 일은 retain, release를 해주는 것이며 내부의 규칙들은 개발자가 따르며 수동적으로 사용해야 한다.**

- Retain Count 방식에 대해 설명하시오.

Count를 획득하는 것을 말한다. 

- Strong 과 Weak 참조 방식에 대해 설명하시오.

강한 참조의 경우 서로 강하게 참조하고 있다는 의미로 참조 시 count가 증가하는 것을 말한다.

약한 참조의 경우 약하게 참조한다는 의미로 참조 시 count가 증가하지 않는 것을 말한다.

- 순환 참조에 대하여 설명하시오.

순환 참조란 두 가지 이상의 인스턴스가 서로 강한 참조 상태인 것을 말하며 이를 통해 한 곳에서 nil로 값을 변경해서 메모리 해제를 하려고 해도 강한 참조로 인해 count가 남아 있어서 해제가 되지 않고 memory leak이 일어나는 것을 말한다.

- 강한 순환 참조 (Strong Reference Cycle) 는 어떤 경우에 발생하는지 설명하시오.

두 프로퍼티가 존재하고 서로 각 클래스 내에서 저장 프로퍼티로 강하게 참조를 하고 있을 때, 각각을 실제로 인스턴스 만들 때 참조 카운트가 증가하게 되어 서로 2씩이 된다. 이 상황에서 한 곳을 nil로 할 때 이곳의 카운트가 1이 되며 메모리 해제가 이루어지지 않아서 메모리 누수가 일어날 수 있는 문제점이 생긴다.