# mutating, CoW

조체는 값 타입이고 구조체의 인스턴스가 상수로 생성되면 프로퍼티는 변할 수 없다 - 이 말은 즉, 구조체가 상수면 내부의 프로퍼티가 상수이든 변수이든 상관없이 다 상수가 된다.

문제는 만약 구조체를 만들게 되면 스위프트는 이것을 상수로 이용할지 변수로 이용할지를 알 수가 없다.

기본적으로 안전한 접근이 취해진다: 스위프트는 내가 요청하지 않는다면 프로퍼티를 바꾸게하는 메소드를 쓰지 못하게 한다. 

그말은 즉, `mutating` 를 사용해서 프로퍼티를 바꾸게 하는 메소드를 사용하고 싶다고 말하는 것이다!

Swift는 일반적으로 값을 복사할 때 `COW(Copy on Write)`
 방식을 사용하게 됩니다. 즉, 실제 복사는 값이 변경될 때 복사가 됩니다. 만약, 구조체 메서드 내부에서 값을 변경하게되면 컴파일러는 알 방법이 없어 `mutating`
 키워드를 사용하여 내부에서 값을 변경한다는 것을 컴파일러에게 알려주게 됩니다.

여기에서 Cow란?

수정(쓰기)이 일어날 때 복사한다는 의미다

스위프트의 컬렉션 타입인 Array, Dictionary, Set에만 적용되는 개념이다

참조를 통해 불필요한 복사를 줄일 수 있다.

예를 들어 배열에 1000개의 요소가 있는데 이를 복사하면 두개의 동일한 것이 나올 수 있다.  동일한 것인데 큰 요소의 배열을 두개나 만드는 것은 효율이 떨어질 수 있다. 그래서 포인트를 통해 동일한 곳을 바로보게 할 수 있다. 그래서 만약 복사한 배열에서 변화가 일어나게 된다면 이때서야 전체에 대해 복사를 한 다음 변화하게 만드는 것이다. 그래서 이전까지 동작하지 않을 떄에는 이를 건드리지 않고 포인터로 이 주소만을 참조하고 있는 상태로 둔다.

각각의 메모리 주소는 다르지만 두번 째의 인스턴스 주소는 첫번째가 되는 것이다.

메모리 주소는 각각 영역을 할당받는 것이고 참조로 이를 사용하는 것은 인스턴스 주소인것이다!

즉, 실제 복사는 값이 변경될 때 복사가 됩니다. 만약, 구조체 메서드 내부에서 값을 변경하게되면 컴파일러는 알 방법이 없어 `mutating` 키워드를 사용하여 내부에서 값을 변경한다는 것을 컴파일러에게 알려주게 됩니다.

위 문구에서 의문이 생겼으며 이러한 질문에 대해서는 리뷰어들과 이야기하며 해결하게 되었습니다!!!!

1. 왜 구조체 내부에서 값 변경하는 것을 컴파일러는 모를까요? 내부 변경은 컴파일 타임에 진행되는게 아니고 언제 되는지? 처음에는 런타임에서 하기 때문에 모른다고 생각했는데 그럼 스택의 크기는 이미 정해져있는데 이렇게 해도 되는건지..  또 이게 맞는건지..?

→ 컴파일러는 알고있다! 컴파일러가 처음 mutating를 컴파일 타임에 확인하고 이에 대한 실제 행동은 런타임에 이루어진다. 그래서 결론은 컴파일 타임에 컴파일러는 이미 저것을 확인하고 준비되어 있다! 그리고 스택의 크기는 Int, String 같은 경우 주소값을 들고 있기 때문에 메모리 크기의 변동이 없을테고, 어레이 같은것은 힙에 들어가니 괜찮고 하니 스택의 크기를 변동시키는 행동은 없을 듯싶다.

1.  컴파일 타임에 왜 스트럭트에서 mutating 된 것을 파악못하는지? 이미 코드는 짜여져있는데??

→ 파악가능 1번 대답

1. 또 만약 스트럭트 인스턴스 생성하는 함수에서 버튼 누를 떄마다 이를 호출하면 이는 어디에 저장하는지? 컴파일 타임에 스택의 크기가 더 저장되어있을텐데..?

→ 이것도 1번과 비슷한 맥락인데, 어레이를 append하는ㄴ 경우는 힙에 들어가므로 상관 없고, 스택으로 가는 건 인스턴스 생성하고 다음 인스턴스 생성할 때인데 이는 기존의 인스턴스를 교체하는 식으로 들어갈 것같다. 그래서 스택의 크기에는 변동이 없을듯 싶다.

1. mutating 한다는게 새 구조체에 덮어쓰기를 하는 것같은데, 그러면 모든 것을 다 덮어쓰어서 하는데 이거 자체가 비효율적인게 아닌지? mutating한 곳만 덮어쓰기 하는게 더 효율적인 방법이 아닌가싶은데 잘못된 생각인지? 여기에서 참조에서는 근데 왜 되는지..?

→ 만약 일부만 덮어쓰기를 하는 것이라면 클래스와 스트럭트를 나누는 이유가 없지 않나?

그리고 구조체 인스턴스가 스택에 올라가니 사실상 인스턴스 안의 프로퍼티만 바꿔치기 하는것은 불가능해 보인다. 그래서 인스턴스 전체를 바꿔치기 하면서 변경이 일어난다!